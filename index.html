<!DOCTYPE html>
<html>
<head>
  <title>Spacewars Game</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevent scrolling */
    }

    canvas {
      border: 1px solid black;
      background-color: black;
    }
  #joystick {
    position: absolute;
    bottom: 30px;  /* Closer to the bottom */
    left: 50%;
    transform: translateX(-50%);
    width: 140px;  /* Increased width by 40% */
    height: 140px; /* Increased height by 40% */
    background-color: rgba(255, 255, 255, 0.2);
    border: 3px solid #fff;
    border-radius: 50%;
  }

  #joystick-inner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;  /* Adjusted inner circle size */
    height: 60px;  /* Adjusted inner circle size */
    background-color: white;
    border-radius: 50%;
    border: 2px solid #fff;  /* Added border for better visibility */
  }

  #joystick .handle {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 70px;  /* Increased width by 40% */
    height: 70px; /* Increased height by 40% */
    background-color: rgba(255, 255, 255, 0.7);
    border: 2px solid #fff;
    border-radius: 50%;
  }
  #marketplace {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #111; /* Dark background */
    padding: 20px;
    border: 3px solid #f00; /* Red border */
    color: #0f0; /* Green text color */
    width: 90%;
    max-width: 400px;
    box-sizing: border-box;
    font-family: 'Press Start 2P', cursive; /* Arcade font */

    text-align: center;
  }

  #marketplace h2 {
    font-size: 24px;
    margin-bottom: 20px;
  }

  #marketplace p, #marketplace button {
    font-size: 14px;
    margin: 10px 0;
  }

  #marketplace button {
    background-color: #222; /* Dark button background */
    color: #0f0; /* Green text color */
    border: 2px solid #f00; /* Red border */
    padding: 10px;
    width: 100%;
    cursor: pointer;
    font-family: 'Press Start 2P', cursive; /* Arcade font */
  }

  #marketplace button:hover {
    background-color: #333; /* Slightly lighter background on hover */
  }
  #restartButton {
    position: absolute;
    top: 70%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px 40px;
    font-size: 24px;
    display: none;
    background-color: white;
    border: 2px solid black;
    border-radius: 5px;
    cursor: pointer;
  }
    #startScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      color: white;
      z-index: 10;
      background-color: #111; /* Dark background */
      padding: 20px;
      color: #0f0; 
      box-sizing: border-box;
      font-family: 'Press Start 2P', cursive; /* Arcade font */
      text-align: center;

    }

#startScreen h2 {
  font-size: 4em; /* Increased heading size */
  margin-bottom: 20px;
}

#startScreen p {
  font-size: 2.2em; /* Increased paragraph size */
  margin-bottom: 20px;
}

#startScreen button {
  font-size: 1.2em; /* Increased button text size */
  padding: 10px 20px;
}

  #leaderboard-container {
    display: none;
    position: absolute;
    top: 25%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #111; /* Dark background */
    padding: 20px;
    border: 3px solid #f00; /* Red border */
    color: #0f0; /* Green text color */
    width: 90%;
    max-width: 400px;
    box-sizing: border-box;
    font-family: 'Press Start 2P', cursive; /* Arcade font */
    text-align: center;
  }

  #leaderboard h2 {
    font-size: 24px;
    margin-bottom: 20px;
  }

  #leaderboard ol {
    list-style: none;
    padding: 0;
  }

  #leaderboard ol li {
    font-size: 14px;
    margin: 10px 0;
    border-bottom: 1px solid #f00; /* Red border for each entry */
    padding-bottom: 5px;
  }

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

</head>
<body>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <div id="joystick">
    <div id="joystickHandle"></div>

  </div>
  <div id="startScreen">
    <div>
      <h2>Welcome to Infinite War!</h2>
      <p>Use the joystick to move your ship.</p>
      <p>Tap the left and right sides of the screen to rotate your ship.</p>
      <p>Tap the center of the screen to accelerate.</p>
      <p>Tap lower left for store.</p>
      <!-- <p>Tap with two fingers to fire.</p> -->
      <button onclick="startGame()">Start Game</button>
    </div>
  </div>

  <div id="marketplace">
		<h2>Marketplace</h2>
		<p>Coins: <span id="coins">0</span></p>
		<button onclick="upgrade('lasers')">Upgrade Lasers (Cost: 100)</button> Level: <span id="laserLevel">1</span><br>
  <button onclick="upgrade('maxbullets')">Upgrade Max Bullets (Cost: 100)</button> Level: <span id="maxBulletsLevel">1</span><br>
<button onclick="upgrade('laserCooldown')">Upgrade Laser Cooldown (Cost: 100)</button> Level: <span id="laserCooldownLevel">1</span><br>
    <button onclick="upgrade('explosivelaser')">Explosive Lasers (Cost: 100)</button> Level: <span id="explosiveLaserLevel">1</span><br>


		<!-- <button onclick="upgrade('acceleration')">Upgrade Acceleration (Cost: 100)</button> Level: <span id="accelerationLevel">1</span><br> -->
		<button onclick="upgrade('rotationSpeed')">Upgrade Rotation Speed (Cost: 100)</button> Level: <span id="rotationSpeedLevel">1</span><br>
		<button onclick="buyDrone()">Buy Drone (Cost: 800)</button><br>
		<button onclick="upgradeDrone('speed')">Upgrade Drone Speed (Cost: 200)</button> Level: <span id="droneSpeedLevel">1</span><br>
		<!-- <button onclick="upgradeDrone('laserSpeed')">Upgrade Drone Laser Speed (Cost: 200)</button> Level: <span id="droneLaserSpeedLevel">1</span><br> -->
		<button onclick="upgradeDrone('laserInterval')">Upgrade Drone Firing Frequency (Cost: 200)</button> Level: <span id="droneLaserIntervalLevel">1</span><br>
		<button onclick="exitMarketplace()">Exit Marketplace</button>
  </div>

  <div id="leaderboard-container" style="display:none;">
  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <ol id="leaderboard-list"></ol>
  </div>
</div>

 <audio id="background-music" src="sounds/music_loop.mp3" loop></audio>

<audio id="meteor-destroy-1" src="sounds/meteor_destroy.mp3"></audio>
<audio id="meteor-destroy-2" src="sounds/meteor_destroy2.mp3"></audio>
<audio id="meteor-destroy-3" src="sounds/meteor_destroy3.mp3"></audio>

<audio id="shot-sound-1" src="sounds/shot1.mp3"></audio>
<audio id="shot-sound-2" src="sounds/shot2.mp3"></audio>
<audio id="shot-sound-3" src="sounds/shot3.mp3"></audio>

<audio id="thruster-sound-1" src="sounds/thruster1.mp3"></audio>
<audio id="thruster-sound-2" src="sounds/thruster2.mp3"></audio>
<audio id="thruster-sound-3" src="sounds/thruster3.mp3"></audio>


<audio id="ship-destroyed" src="sounds/ship_destroyed.mp3"></audio>

  <button id="restartButton" style="display: none;">Restart</button>

  <script>
    // Get the canvas element
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const joystick = document.getElementById('joystick');
    const joystickInner = document.getElementById('joystick-inner');
  	const joystickHandle = document.getElementById('joystickHandle');
  	const restartButton = document.getElementById('restartButton');
    const backgroundMusic = document.getElementById('background-music');

  	let isTouchingJoystick = false;
  	let joystickStartX, joystickStartY;

    const marketplace = document.getElementById('marketplace');
    const coinsDisplay = document.getElementById('coins');

  	const laserLevelDisplay = document.getElementById('laserLevel');
  	// const accelerationLevelDisplay = document.getElementById('accelerationLevel');
    const maxBulletsLevelDisplay = document.getElementById('maxBulletsLevel');
  	const rotationSpeedLevelDisplay = document.getElementById('rotationSpeedLevel');
  	const droneSpeedLevelDisplay = document.getElementById('droneSpeedLevel');
  	// const droneLaserSpeedLevelDisplay = document.getElementById('droneLaserSpeedLevel');
  	const droneLaserIntervalLevelDisplay = document.getElementById('droneLaserIntervalLevel');

    let superWeapons = {
      missile: 0,
      laser: 0,
      bomb: 0
    };

    let ship = {
      x: canvas.width / 2,
      y: canvas.height - 50,
      size: 20,
      speed: 0,
      acceleration: 0.15,
      deceleration: 0.98,
      maxSpeed: 5,
      rotation: 0,
      rotationSpeed: 2.5,
      lasers: [],
      velocityX: 0,
      velocityY: 0,
      laserLevel: 1,
      accelerationLevel: 1,
      rotationSpeedLevel: 1,
      maxBulletsLevel: 1,
      explosiveLaserLevel: 1,
      laserCooldown: 30,
      laserTimer: 0,
      laserCooldownLevel: 1,

    };

    let drone = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      size: 10,
      speed: 0.0001,
      direction: Math.random() * Math.PI * 2,
      lasers: [],
      laserSpeed: 3,
      laserInterval: 120, // Fire lasers every 120 frames (2 second)
      laserTimer: 0
    };

	// let upgrades = {
	//   explosiveLasers: 0, // Initial level of explosive lasers
	//   emp: 0
	// };


const resizeCanvas = () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  resetShip();
  // Scale the canvas to handle high DPI screens
  // ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  // // Reposition the ship to the center of the canvas
  // ship.x = canvas.width / 2 / window.devicePixelRatio;
  // ship.y = canvas.height - 50 / window.devicePixelRatio;
};
		resizeCanvas();
		

// KEY CONFIG VARs
    let coins = 0;

    const baseUrl = 'https://rzzuxqt0hi.execute-api.eu-central-1.amazonaws.com/Prod/api';
    let gameSessionId = '';

    let score = 0;
    let asteroids = [];
    let gameLoop;
    let explosions = [];
    let lives = 3;
    let gameOver = false;
    let invincible = false;
    let invincibilityTimer = 0;
    const invincibilityDuration = 120; // 2 seconds (60 FPS)
    let wave = 1;
    let waveMessageTimer = 0;
    const waveMessageDuration = 180; // 3 seconds (60 FPS)
    let asteroidsKilled = 0;
	let drones = [];
	const droneCost = 800;
	
	let bonusCoins = 0;

	let droneUpgrades = {
	  speed: 1,
	  laserSpeed: 1,
	  laserInterval: 1
	};


    // Event listeners for keyboard input
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);



	// canvas.addEventListener('touchmove', (e) => {
	//   if (isTouching) {
	//     let touchX = e.touches[0].clientX;
	//     let touchY = e.touches[0].clientY;
	//     let deltaX = touchX - touchStartX;
	//     let deltaY = touchY - touchStartY;

	//     ship.rotation = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
	//     ship.speed = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY) / 15, ship.maxSpeed); // Changed divisor from 10 to 5 for easier control

	//     touchStartX = touchX;
	//     touchStartY = touchY;
	//   }
	// });

	canvas.addEventListener('touchstart', (e) => {

		// lower left corner to access store
		if (e.touches[0].clientX < canvas.width / 5 && e.touches[0].clientY > canvas.height * 4 / 5) {
	    pauseGameForMarketplace();
	  }

	  if (e.target === canvas && e.touches.length === 2) { // Require two fingers to fire
	    ship.lasers.push({ x: ship.x, y: ship.y, rotation: ship.rotation, size: 2 });
	  }
	});

    // Game loop
    function startGame() {
      document.getElementById('startScreen').style.display = 'none';
      createAsteroids();
      invincible = true;
      ship.laserTimer = 0;
      invincibilityTimer = invincibilityDuration;
      gameLoop = setInterval(update, 1000 / 60); // 60 FPS
      backgroundMusic.play(); // Play the background music
      startGamingSessionApi();
    }

function startGamingSessionApi() {
  const a = new URLSearchParams(window.location.href);

  if (!a.get('userId')) return;

  const gameRequestId = a.get('gameRequestId');

  fetch(`${baseUrl}/telegram-game/start-game?gameRequestId=${gameRequestId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      gameSessionId = data;
        console.log('Success:', data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function endGameSessionApi(score) {
  const a = new URLSearchParams(window.location.href);
  if (!a.get('userId')) return;

  const gameRequestId = a.get('gameRequestId');

  const inMsgId = a.get('inMsgId').split('#')[0];
  const userId = a.get('userId');

  return fetch(`${baseUrl}/telegram-game/end-game?gameRequestId=${gameRequestId}&gameSessionId=${gameSessionId}&inMsgId=${inMsgId}&userId=${userId}&score=${score}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function getLeaderboard() {
  if (!a.get('userId')) return;

  return fetch(`${baseUrl}/telegram-game/leaderboard?userId=${a.get('userId')}`, {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success leaderboard fetch:', data);
      return data;
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function getActivityStats() {
  if (!a.get('userId')) return;

  return fetch(`${baseUrl}/telegram-game/activity-stats`, {
    method: 'GET'
  }).then(s => s.json())
  .then(data => {
    console.log('Success activity stats fetch:', data);
    return data;
  })
  .catch(error => {
    console.error('Error:', error);
  })
}

function update() {


  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (ship.laserTimer > 0) {
    ship.laserTimer--;
  }

  let angle = ship.rotation * Math.PI / 180;

  if(isMobile())
    keys[' '] = true;

  // Apply acceleration based on key states
  if (keys['ArrowUp'] || keys['w']) {

    backgroundMusic.play(); // Resume the background music (if hasn't started)
    playRandomThrusterSound(); 

    if (ship.speed < ship.maxSpeed) {
      ship.speed += ship.acceleration;
    }
  } else if (keys['ArrowDown'] || keys['s']) {
    if (ship.speed > -2) {
      ship.speed -= (ship.acceleration * 3);
      playRandomThrusterSound(); 

    }

  } else {
    // Apply deceleration when no acceleration key is pressed
    ship.speed *= ship.deceleration;
  }

  // Update ship velocity based on speed and angle
  ship.velocityX = ship.speed * Math.sin(angle);
  ship.velocityY = -ship.speed * Math.cos(angle);

  // Update ship position based on velocity
  ship.x += ship.velocityX;
  ship.y += ship.velocityY;

  // Wrap the ship around the screen edges
  if (ship.x < 0) ship.x = canvas.width;
  else if (ship.x > canvas.width) ship.x = 0;
  if (ship.y < 0) ship.y = canvas.height;
  else if (ship.y > canvas.height) ship.y = 0;

  // Handle ship rotation based on key states
  if (keys['ArrowLeft'] || keys['a']) {
    ship.rotation -= ship.rotationSpeed;
  }
  if (keys['ArrowRight'] || keys['d']) {
    ship.rotation += ship.rotationSpeed;
  }

  // Handle shooting based on key state and cooldown
  if (keys[' '] && ship.lasers.length < (ship.maxBulletsLevel * 3) && ship.laserTimer === 0) {

    backgroundMusic.play(); // Resume the background music (if hasn't started)

    ship.lasers.push({ x: ship.x, y: ship.y, rotation: ship.rotation, size: ship.laserLevel + 1  });
    ship.laserTimer = ship.laserCooldown;
    playRandomShotSound(); 

  }



  drawShip();
  updateLasers();
  drawLasers();
  updateDrones();
  drawDrones();
  updateAsteroids();
  drawAsteroids();

  if (!invincible) {
    for (let i = 0; i < asteroids.length; i++) {
      if (isColliding(ship, asteroids[i])) {
        createExplosion(ship.x, ship.y);
        resetShip();
        lives--;
        playShipDestroyedSound();
        updateCoinsDisplay();
        invincible = true;
        invincibilityTimer = invincibilityDuration;
        if (lives === 0) gameOver = true;
        else pauseGameForMarketplace();
        break;
      }
    }
  }

  checkLaserCollisions(ship.lasers, true);

  if (invincible) {
    invincibilityTimer--;
    if (invincibilityTimer <= 0) invincible = false;
  }

  drawLives();
  drawScore();
  drawCoins();
  updateExplosions();
  drawExplosions();

  if (asteroids.length === 0 && !gameOver) {
    wave++;
    createAsteroids();
    invincible = true;
    invincibilityTimer = invincibilityDuration;
    waveMessageTimer = waveMessageDuration;
  }

  if (waveMessageTimer > 0) {
    drawWaveMessage();
    waveMessageTimer--;
  }

  if (gameOver) endGame();
}



function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);

}

document.addEventListener('DOMContentLoaded', () => {
  if (isMobile()) {
    document.getElementById('startScreen').style.display = 'flex';
  } else {
    startGame();
  }
});


// Function to handle laser collisions
function checkLaserCollisions(lasers, isShip) {
  for (let i = lasers.length - 1; i >= 0; i--) {
    let laser = lasers[i];
    for (let j = asteroids.length - 1; j >= 0; j--) {
      let asteroid = asteroids[j];
      if (isColliding(laser, asteroid)) {
        if (true) {
          createExplosion(asteroid.x, asteroid.y, asteroid.hitPoints); // Smaller, redder explosion
          asteroid.hitPoints--;
          if (asteroid.hitPoints <= 0) {
            asteroids.splice(j, 1);
          } else {
            // Lighten the color slightly
            let colorValue = Math.max(40, 30 + (asteroid.hitPoints * 3)); // Adjust color value
            asteroid.color = `rgb(${colorValue}, ${colorValue}, ${colorValue})`;
          }
        } else {
          createExplosion(asteroid.x, asteroid.y, asteroid.hitPoints); // Regular explosion
          if (ship.explosiveLaserLevel > 1) {
            // Create additional explosions for nearby objects
            createAreaDamage(asteroid.x, asteroid.y, ship.explosiveLaserLevel * 5); // 50 is the radius of the explosion
          }
          asteroids.splice(j, 1);
        }

        lasers.splice(i, 1);
        score += 50;
        asteroidsKilled++;
        playRandomMeteorDestroySound();

        if (isShip) {
          coins += 20; // Add coins when score increases
          updateCoinsDisplay();
        }
        break;
      }
    }
  }
}


const meteorDestroySounds = [
  document.getElementById('meteor-destroy-1'),
  document.getElementById('meteor-destroy-2'),
  document.getElementById('meteor-destroy-3')
];

// Get the audio elements for shots
const shotSounds = [
  document.getElementById('shot-sound-1'),
  document.getElementById('shot-sound-2'),
  document.getElementById('shot-sound-3')
];

// Get the audio elements for thrusters
const thrusterSounds = [
  document.getElementById('thruster-sound-1'),
  document.getElementById('thruster-sound-2'),
  document.getElementById('thruster-sound-3')
];


// Get the audio elements for thrusters
const shipDestroyedSounds = [
  document.getElementById('ship-destroyed')
];

// Function to play a random shot sound
function playRandomShotSound() {
  const randomIndex = Math.floor(Math.random() * shotSounds.length);
  shotSounds[randomIndex].play();
}

// Function to play a random thruster sound
function playRandomThrusterSound() {
  const randomIndex = Math.floor(Math.random() * thrusterSounds.length);
  thrusterSounds[randomIndex].play();
}

function playRandomMeteorDestroySound() {
  const randomIndex = Math.floor(Math.random() * meteorDestroySounds.length);
  meteorDestroySounds[randomIndex].play();
}


function playShipDestroyedSound() {
  const randomIndex = Math.floor(Math.random() * shipDestroyedSounds.length);
  shipDestroyedSounds[randomIndex].play();
}


// Function to buy drones
function buyDrone() {
  if (coins >= droneCost) {
    coins -= droneCost;
    let drone = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      size: 10,
      speed: 0.5 * droneUpgrades.speed,
      direction: Math.random() * Math.PI * 2,
      lasers: [],
      laserSpeed: 2 * droneUpgrades.laserSpeed,
      laserInterval: 360 / droneUpgrades.laserInterval, // Fire lasers more frequently as the interval increases
      laserTimer: 0
    };
    drones.push(drone);
    updateCoinsDisplay();
  }
}

function upgradeDrone(attribute) {
  const cost = 200;
  if (coins >= cost) {
    coins -= cost;
    droneUpgrades[attribute]++;

    // Update existing drones with new upgrade levels
    drones.forEach(drone => {
      switch (attribute) {
        case 'speed':
          drone.speed = 2 * droneUpgrades.speed;
          break;
        case 'laserSpeed':
          drone.laserSpeed = 5 * droneUpgrades.laserSpeed;
          break;
        case 'laserInterval':
          drone.laserInterval = 360 / droneUpgrades.laserInterval;
          break;
      }
    });
    updateCoinsDisplay();
    updateMarketplaceDisplay();

  }
}

// Update all drones
function updateDrones() {
  drones.forEach(drone => {
    const dx = ship.x - drone.x;
    const dy = ship.y - drone.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 200) { // If the drone is too far from the ship
      const angleToShip = Math.atan2(dy, dx);
      drone.direction = angleToShip; // Change direction towards the ship
    }

    drone.x += Math.cos(drone.direction) * drone.speed;
    drone.y += Math.sin(drone.direction) * drone.speed;

    if (drone.x < 0) drone.x = canvas.width;
    else if (drone.x > canvas.width) drone.x = 0;
    if (drone.y < 0) drone.y = canvas.height;
    else if (drone.y > canvas.height) drone.y = 0;

    for (let i = drone.lasers.length - 1; i >= 0; i--) {
      let laser = drone.lasers[i];
      laser.x += Math.cos(laser.direction) * drone.laserSpeed;
      laser.y += Math.sin(laser.direction) * drone.laserSpeed;

      if (laser.x < 0 || laser.x > canvas.width || laser.y < 0 || laser.y > canvas.height) {
        drone.lasers.splice(i, 1);
      }
    }

    drone.laserTimer++;
    if (drone.laserTimer >= drone.laserInterval) {
      drone.laserTimer = 0;
      let laser = {
        x: drone.x,
        y: drone.y,
        direction: Math.random() * Math.PI * 2,
        size: 2
      };
      drone.lasers.push(laser);
    }

    checkLaserCollisions(drone.lasers, false);
  });
}

function drawDrones() {
  drones.forEach(drone => {
    ctx.save();
    ctx.translate(drone.x, drone.y);
    ctx.rotate(drone.direction);
    ctx.beginPath();
    ctx.moveTo(0, -drone.size);
    ctx.lineTo(-drone.size, drone.size);
    ctx.lineTo(drone.size, drone.size);
    ctx.closePath();
    ctx.fillStyle = 'cyan';
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = 'cyan';
    for (let i = 0; i < drone.lasers.length; i++) {
      let laser = drone.lasers[i];
      ctx.fillRect(laser.x - 1, laser.y - 1, 2, 2);
    }
  });
}

    function drawLives() {
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      ctx.textAlign = 'right';
      ctx.fillText('Lives: ' + lives, canvas.width - 20, 30);
    }

    function drawCoins() {
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      ctx.textAlign = 'left';
      let coinmessage =  'Coins: ' + coins;
      if(isMobile())
          coinmessage = coinmessage + '    tap for store';
      else
          coinmessage = coinmessage +  "    'x' for store";

      ctx.fillText(coinmessage, 20, canvas.height - 30);
    }

    // function drawDrone() {
    //   ctx.save();
    //   ctx.translate(drone.x, drone.y);
    //   ctx.rotate(drone.direction);
    //   ctx.beginPath();
    //   ctx.moveTo(0, -drone.size);
    //   ctx.lineTo(-drone.size, drone.size);
    //   ctx.lineTo(drone.size, drone.size);
    //   ctx.closePath();
    //   ctx.fillStyle = 'cyan';
    //   ctx.fill();
    //   ctx.restore();

    //   // Draw drone lasers
    //   ctx.fillStyle = 'cyan';
    //   for (let i = 0; i < drone.lasers.length; i++) {
    //     let laser = drone.lasers[i];
    //     ctx.fillRect(laser.x - 1, laser.y - 1, 2, 2);
    //   }
    // }

function endGame() {
  clearInterval(gameLoop);
  backgroundMusic.pause(); // Stop the background music

  ctx.fillStyle = 'white';
  ctx.font = '40px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Game Over', canvas.width / 2, canvas.height / 2);
  ctx.font = '20px Arial';
  ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height / 2 + 40);
  ctx.fillText(`Asteroids Destroyed: ${asteroidsKilled}`, canvas.width / 2, canvas.height / 2 + 70);

  // Calculate and display coins for next round
  bonusCoins = Math.floor(score * 0.06);
  coins += bonusCoins;
  ctx.fillText(`Bonus Coins for Next Round: ${bonusCoins}`, canvas.width / 2, canvas.height / 2 + 100);

  // Show the restart button
  restartButton.style.display = 'block';

  (async () => {
    await endGameSessionApi(score);

    const leaderboard = await getLeaderboard();

    console.log(leaderboard);
  })().then(_=>console.log('Requests sent'));
  
  fetchLeaderboard();
  const a = new URLSearchParams(window.location.href)

  if(a && a.get('inMsgId'))
  {
    fetch(`https://rzzuxqt0hi.execute-api.eu-central-1.amazonaws.com/Prod/api/telegram-webhook/test-score?userId=${a.get('userId')}&score=${score}&inMsgId=${a.get('inMsgId').split('#')[0]}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
  }

}

    function pauseGameForMarketplace() {
      clearInterval(gameLoop);
      marketplace.style.display = 'block';
      backgroundMusic.pause(); // Pause the background music

    }

	function exitMarketplace() {
	  marketplace.style.display = 'none';
	  invincible = true;
	  invincibilityTimer = invincibilityDuration;
	  updateMarketplaceDisplay(); // Update display to reflect current levels
	  gameLoop = setInterval(update, 1000 / 60); // Resume game loop
    backgroundMusic.play(); // Resume the background music

	}

    function upgrade(attribute) {
      const cost = 100;
      if (coins >= cost) {
        coins -= cost;
        switch (attribute) {
          case 'lasers':
            ship.laserLevel++;
            break;
          case 'maxbullets':
            ship.maxBulletsLevel++;
            break;
          case 'explosivelaser':
            ship.explosiveLaserLevel++;
            break;
          case 'acceleration':
            ship.accelerationLevel++;
            ship.acceleration = 0.1 * ship.accelerationLevel;
            break;
        case 'laserCooldown':
            ship.laserCooldownLevel++;
            ship.laserCooldown = Math.max(5, ship.laserCooldown - 3);
            break;
        case 'rotationSpeed':
            ship.rotationSpeedLevel++;
            ship.rotationSpeed = 2 * ship.rotationSpeedLevel;
            break;
        }
        updateMarketplaceDisplay();
        updateCoinsDisplay();
      }
    }

    function updateCoinsDisplay() {
      coinsDisplay.textContent = coins;
    }

    // Draw the ship
    function drawShip() {
      if (!invincible || (invincibilityTimer % 20 < 10)) {
        ctx.save();
        ctx.translate(ship.x, ship.y);
        ctx.rotate(ship.rotation * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(0, -ship.size);
        ctx.lineTo(-ship.size, ship.size);
        ctx.lineTo(ship.size, ship.size);
        ctx.closePath();
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.restore();
      }
    }

    // Draw lasers
    function drawLasers() {
      ctx.fillStyle = 'red';
      for (let i = 0; i < ship.lasers.length; i++) {
        ctx.fillRect(ship.lasers[i].x - 1, ship.lasers[i].y - 1, ship.laserLevel + 3, ship.laserLevel + 3); // Drawing lasers as small squares for better collision detection
      }
    }

    // Update lasers
    function updateLasers() {
      for (let i = 0; i < ship.lasers.length; i++) {
        let laser = ship.lasers[i];
        laser.x += 10 * Math.sin(laser.rotation * Math.PI / 180);
        laser.y -= 10 * Math.cos(laser.rotation * Math.PI / 180);

        // Remove lasers that are off-screen
        if (laser.x < 0 || laser.x > canvas.width || laser.y < 0 || laser.y > canvas.height) {
          ship.lasers.splice(i, 1);
          i--;
        }
      }
    }

	function isColliding(obj1, obj2) {
	  let dx = obj1.x - obj2.x;
	  let dy = obj1.y - obj2.y;
	  let distance = Math.sqrt(dx * dx + dy * dy);
	  return distance < (obj1.size || 1) + obj2.size;
	}




    function drawScore() {
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      ctx.textAlign = 'left';
      //version
      ctx.fillText('(v 0.158) Score: ' + score, 20, 30);
    }

    // Draw wave message
    function drawWaveMessage() {
      ctx.fillStyle = 'white';
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Wave ' + wave, canvas.width / 2, canvas.height / 2);
    }

let chanceForSmallAsteroid = 3;
let chanceForVerySmallAsteroid = 1;
let chanceForHardenedAsteroid = 5;
let chanceForVeryHardenedAsteroid = 2; // Example chance for very hardened asteroid

function createAsteroids() {
  let numberOfAsteroids = 10 + (wave - 1) * 1.5;

  for (let i = 0; i < numberOfAsteroids; i++) {
    let isSmallAsteroid = Math.random() * 100 < chanceForSmallAsteroid;
    let isVerySmallAsteroid = Math.random() * 100 < chanceForVerySmallAsteroid;
    let isHardenedAsteroid = Math.random() * 100 < chanceForHardenedAsteroid;
    let isVeryHardenedAsteroid = Math.random() * 100 < chanceForVeryHardenedAsteroid;

    let asteroidSize = isSmallAsteroid ? 10 : 20;
    let asteroidSpeedMultiplier = isSmallAsteroid ? 1.5 : 1;

    if (isVerySmallAsteroid) {
      asteroidSize = 5;
      asteroidSpeedMultiplier = 2;
    }

    let x, y;
    let spawnArea = Math.random();

    if (spawnArea < 0.25) {
      // Top edge
      x = Math.random() * canvas.width;
      y = Math.random() * (canvas.height * 0.3);
    } else if (spawnArea < 0.5) {
      // Right edge
      x = canvas.width * 0.7 + Math.random() * (canvas.width * 0.3);
      y = Math.random() * canvas.height;
    } else if (spawnArea < 0.75) {
      // Bottom edge
      x = Math.random() * canvas.width;
      y = canvas.height * 0.7 + Math.random() * (canvas.height * 0.3);
    } else {
      // Left edge
      x = Math.random() * (canvas.width * 0.3);
      y = Math.random() * canvas.height;
    }

    let hitPoints;
    let color;

    if (isVeryHardenedAsteroid) {
      hitPoints = 15;
      color = '#0A1414'; // Very dark green color for very hardened asteroids
    } else if (isHardenedAsteroid) {
      hitPoints = Math.floor(Math.random() * 5) + 3; // Random hitpoints between 5 and 8
      color = '#172727'; // Dark green color for hardened asteroids
    } else {
      hitPoints = 1;
      color = 'gray';
    }

    let asteroid = {
      x: x,
      y: y,
      size: asteroidSize,
      speed: asteroidSpeedMultiplier * Math.pow(1.035, wave - 1),
      dx: (Math.random() * 2 - 1) * asteroidSpeedMultiplier * Math.pow(1.035, wave - 1),
      dy: (Math.random() * 2 - 1) * asteroidSpeedMultiplier * Math.pow(1.035, wave - 1),
      hitPoints: hitPoints,
      // isHardened: isHardenedAsteroid || isVeryHardenedAsteroid,
      color: color
    };

    asteroids.push(asteroid);
  }

  chanceForSmallAsteroid += 0.5;
  chanceForVerySmallAsteroid += 0.1;
  chanceForHardenedAsteroid += 0.5;
  chanceForVeryHardenedAsteroid += 0.2; // Increase the chance for very hardened asteroids
}



    // Update asteroids
function updateAsteroids() {
    for (let i = 0; i < asteroids.length; i++) {
        asteroids[i].x += asteroids[i].dx * asteroids[i].speed;
        asteroids[i].y += asteroids[i].dy * asteroids[i].speed;

        // Wrap asteroids around the screen
        if (asteroids[i].x < 0) {
            asteroids[i].x = canvas.width;
        } else if (asteroids[i].x > canvas.width) {
            asteroids[i].x = 0;
        }
        if (asteroids[i].y < 0) {
            asteroids[i].y = canvas.height;
        } else if (asteroids[i].y > canvas.height) {
            asteroids[i].y = 0;
        }
    }
}

    // Draw asteroids
    function drawAsteroids() {
      for (let i = 0; i < asteroids.length; i++) {
        ctx.fillStyle = asteroids[i].color;
        ctx.beginPath();
        ctx.arc(asteroids[i].x, asteroids[i].y, asteroids[i].size, 0, Math.PI * 2);
        ctx.closePath();
        ctx.fill();
      }
    }


	// Function to create area damage
	function createAreaDamage(x, y, radius) {
        // console.log("createAreaDamage");

	  for (let i = asteroids.length - 1; i >= 0; i--) {
	    let asteroid = asteroids[i];
	    let dx = asteroid.x - x;
	    let dy = asteroid.y - y;
	    let distance = Math.sqrt(dx * dx + dy * dy);
	    if (distance < radius) {
        // console.log("explosion");

	      createExplosion(asteroid.x, asteroid.y, asteroid.hitPoints);
        if(asteroid.hitPoints > 3)
  	      asteroids.splice(i, 1);
        else
          asteroid.hitPoints--; 

        coins += 15;
	      score += 50;
	    }
	  }
	}


function createExplosion(x, y, hitpoints = 0) {
  const randomSize = Math.random() * 20 + 20;
  const randomAlphaDecay = Math.random() * 0.01 + 0.005; // Random alpha decay between 0.005 and 0.015
  let randomColor;
  if (hitpoints > 7)
    randomColor = getRandomPurpleShade();
  else if (hitpoints > 1) 
    randomColor = getRandomBlueShade();
  else 
    randomColor = getRandomOrangeShade();


  let explosion = {
    x: x,
    y: y,
    size: randomSize,
    alpha: 1,
    alphaDecay: randomAlphaDecay,
    color: randomColor
  };
  explosions.push(explosion);
}

// Function to get a random shade of orange
function getRandomOrangeShade() {
  const shades = ['#FF4500', '#FF6347', '#FF8C00', '#FFA500', '#FF7F50'];
  return shades[Math.floor(Math.random() * shades.length)];
}

function getRandomBlueShade() {
  const shades = ['#1E90FF', '#00BFFF', '#87CEFA', '#4682B4', '#5F9EA0'];
  return shades[Math.floor(Math.random() * shades.length)];
}

function getRandomPurpleShade() {
  const shades = ['#800080', '#8B008B', '#9370DB', '#9400D3', '#9932CC', '#BA55D3', '#DA70D6', '#DDA0DD', '#EE82EE', '#FF00FF'];
  return shades[Math.floor(Math.random() * shades.length)];
}
// Function to get a random shade of red
function getRandomRedShade() {
  const shades = ['#FF0000', '#DC143C', '#B22222', '#FF6347', '#FF4500'];
  return shades[Math.floor(Math.random() * shades.length)];
}

// Update explosions with random alpha decay
function updateExplosions() {
  for (let i = 0; i < explosions.length; i++) {
    explosions[i].size += 1;
    explosions[i].alpha -= explosions[i].alphaDecay;
    if (explosions[i].alpha <= 0) {
      explosions.splice(i, 1);
      i--;
    }
  }
}

	// Draw explosions with random colors
	function drawExplosions() {
	  for (let i = 0; i < explosions.length; i++) {
	    ctx.save();
	    ctx.globalAlpha = explosions[i].alpha;
	    ctx.beginPath();
	    ctx.arc(explosions[i].x, explosions[i].y, explosions[i].size, 0, Math.PI * 2);
	    ctx.closePath();
	    ctx.fillStyle = explosions[i].color;
	    ctx.fill();
	    ctx.restore();
	  }
	}

    // Reset ship position
    function resetShip() {
      ship.x = canvas.width / 2;
      ship.y = canvas.height / 2;
      ship.velocityX = 0;
      ship.velocityY = 0;
      ship.speed = 0;
    }

    function buySuperWeapon(weapon) {
      switch (weapon) {
        case 'missile':
          if (coins >= 200) {
            coins -= 200;
            superWeapons.missile++;
            updateMarketplaceDisplay();
          }
          break;
        case 'laser':
          if (coins >= 300) {
            coins -= 300;
            superWeapons.laser++;
            updateMarketplaceDisplay();
          }
          break;
        case 'bomb':
          if (coins >= 400) {
            coins -= 400;
            superWeapons.bomb++;
            updateMarketplaceDisplay();
          }
          break;
      }
    }

    function useSuperWeapon(weapon) {
      switch (weapon) {
        case 'missile':
          if (superWeapons.missile > 0) {
            superWeapons.missile--;
            activateMissile();
            updateMarketplaceDisplay();
            break;
          }
        case 'laser':
          if (superWeapons.laser > 0) {
            superWeapons.laser--;
            activateLaserBeam();
            updateMarketplaceDisplay();
            break;
          }
        case 'bomb':
          if (superWeapons.bomb > 0) {
            superWeapons.bomb--;
            activateBomb();
            updateMarketplaceDisplay();
            break;
          }
      }
    }

	// Function to update marketplace display
	function updateMarketplaceDisplay() {
	  coinsDisplay.textContent = coins;
	  laserLevelDisplay.textContent = ship.laserLevel;
	  // accelerationLevelDisplay.textContent = ship.accelerationLevel;
    document.getElementById('laserCooldownLevel').textContent = ship.laserCooldownLevel;
    document.getElementById('explosiveLaserLevel').textContent = ship.explosiveLaserLevel;

	  rotationSpeedLevelDisplay.textContent = ship.rotationSpeedLevel;
    maxBulletsLevelDisplay.textContent = ship.maxBulletsLevel;
	  droneSpeedLevelDisplay.textContent = droneUpgrades.speed;
	  // droneLaserSpeedLevelDisplay.textContent = droneUpgrades.laserSpeed;
	  droneLaserIntervalLevelDisplay.textContent = droneUpgrades.laserInterval;
	}

    function activateMissile() {
      // Find the nearest asteroid to the ship
      let nearestAsteroid = null;
      let nearestDistance = Infinity;
      for (let i = 0; i < asteroids.length; i++) {
        let dx = ship.x - asteroids[i].x;
        let dy = ship.y - asteroids[i].y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < nearestDistance) {
          nearestAsteroid = asteroids[i];
          nearestDistance = distance;
        }
      }

      if (nearestAsteroid) {
        // Create an explosion at the nearest asteroid's position
        createExplosion(nearestAsteroid.x, nearestAsteroid.y);
        // Remove the nearest asteroid
        let index = asteroids.indexOf(nearestAsteroid);
        asteroids.splice(index, 1);
        score += 50;
      }
    }

    function activateLaserBeam() {
      // Destroy all asteroids in a straight line in front of the ship
      let angle = ship.rotation * Math.PI / 180;
      let startX = ship.x;
      let startY = ship.y;
      let endX = ship.x + canvas.width * Math.sin(angle);
      let endY = ship.y - canvas.width * Math.cos(angle);

      for (let i = asteroids.length - 1; i >= 0; i--) {
        if (isPointOnLine(asteroids[i].x, asteroids[i].y, startX, startY, endX, endY)) {
          createExplosion(asteroids[i].x, asteroids[i].y);
          asteroids.splice(i, 1);
          score += 50;
        }
      }
    }

    function isPointOnLine(px, py, startX, startY, endX, endY) {
      let threshold = 10; // Adjust this value to control the thickness of the laser beam
      let distance = Math.abs((endY - startY) * px - (endX - startX) * py + endX * startY - endY * startX) / Math.sqrt(Math.pow(endY - startY, 2) + Math.pow(endX - startX, 2));
      return distance <= threshold;
    }

    function activateBomb() {
      // Destroy all asteroids within a certain radius of the ship
      let bombRadius = 100; // Adjust this value to control the size of the bomb explosion
      for (let i = asteroids.length - 1; i >= 0; i--) {
        let dx = ship.x - asteroids[i].x;
        let dy = ship.y - asteroids[i].y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance <= bombRadius) {
          createExplosion(asteroids[i].x, asteroids[i].y);
          asteroids.splice(i, 1);
          score += 50;
        }
      }
    }

let keys = {};

function handleKeyDown(event) {
  keys[event.key] = true;

  if (event.key === 'x') {
    if (marketplace.style.display === 'block') {
      exitMarketplace();
    } else {
      pauseGameForMarketplace();
    }
  }
}

function handleKeyUp(event) {
  keys[event.key] = false;
}

async function fetchLeaderboard() {
  const userId = 190933907; // Replace with dynamic user ID if available
  const response = await fetch(`https://rzzuxqt0hi.execute-api.eu-central-1.amazonaws.com/Prod/api/telegram-webhook/game-leaderboard?userId=${userId}&inMsgId=AQAAAEgOAACDL96FnHtAzSUv6iI`);
  const leaderboard = await response.json();
  displayLeaderboard(leaderboard);
}

function displayLeaderboard(leaderboard) {
  const leaderboardContainer = document.getElementById('leaderboard');
  leaderboardContainer.innerHTML = '<h2>Leaderboard</h2><ol id="leaderboard-list"></ol>';
  const leaderboardList = document.getElementById('leaderboard-list');

  leaderboard.forEach(entry => {
    const listItem = document.createElement('li');
    listItem.textContent = `${entry.position}. ${entry.user.first_name} ${entry.user.last_name || ''} - ${entry.score}`;
    leaderboardList.appendChild(listItem);
  });

  document.getElementById('leaderboard-container').style.display = 'block';
  document.getElementById('coins').textContent = coins;
}


	window.addEventListener('resize', resizeCanvas);

	joystick.addEventListener('touchstart', (e) => {
	  isTouchingJoystick = true;
	  joystickStartX = e.touches[0].clientX;
	  joystickStartY = e.touches[0].clientY;
	});

canvas.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    const touch = e.touches[0];
    const touchX = touch.clientX;

    const canvasWidth = canvas.width;
    const partWidth = canvasWidth / 5; // Divide the canvas width into 5 parts

    if (touchX < partWidth) {
      // Hard left turn
      ship.rotation -= (ship.rotationSpeed * 3);
    } else if (touchX < partWidth * 2) {
      // Soft left turn
      ship.rotation -= ship.rotationSpeed;
    } else if (touchX < partWidth * 3) {
      // Acceleration
      if (ship.speed < ship.maxSpeed) {
        ship.speed += (ship.acceleration * 7);
      }
    } else if (touchX < partWidth * 4) {
      // Soft right turn
      ship.rotation += ship.rotationSpeed;
    } else {
      // Hard right turn
      ship.rotation += (ship.rotationSpeed * 3);
    }
  }
});

	joystick.addEventListener('touchmove', (e) => {
	  if (isTouchingJoystick) {
	    const touchX = e.touches[0].clientX;
	    const touchY = e.touches[0].clientY;
	    const deltaX = touchX - joystickStartX;
	    const deltaY = touchY - joystickStartY;

	    // Calculate angle and distance from the center
	    const angle = Math.atan2(deltaY, deltaX);
	    const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), 50); // Limit the joystick handle movement

	    // Update joystick handle position
	    joystickHandle.style.transform = `translate(${distance * Math.cos(angle)}px, ${distance * Math.sin(angle)}px)`;

	    // Update ship rotation and speed based on joystick movement
	    ship.rotation = angle * (180 / Math.PI); // Convert radians to degrees
	    ship.speed = Math.min(distance / 20, ship.maxSpeed); // Adjust speed based on distance, ensure it doesn't exceed maxSpeed

	    e.preventDefault();
	  }
	});

	joystick.addEventListener('touchend', () => {
	  isTouchingJoystick = false;
	  ship.speed = 0;
	  joystickHandle.style.transform = 'translate(-50%, -50%)'; // Reset joystick handle position
	});

	restartButton.addEventListener('click', () => {
	  restartButton.style.display = 'none';
	  lives = 3;
	  score = 0;
	  coins = 0;
	  wave = 1;
	  coins += bonusCoins;
	  asteroids = [];
	  drones = [];
	  droneUpgrades = {
	  speed: 1,
	  laserSpeed: 1,
	  laserInterval: 1
		};
		
	  ship.laserLevel = 1;
	  ship.accelerationLevel = 1;
	  ship.rotationSpeedLevel = 1;
    ship.laserCooldownLevel = 1;
    ship.maxBulletsLevel = 1;

	  gameOver = false;
	  invincible = true;
	  invincibilityTimer = invincibilityDuration;
    document.getElementById('leaderboard-container').style.display = 'none';
	  createAsteroids();
	  startGame();
	});

    // Start the game
    // startGame();
  </script>
</body>
</html>
